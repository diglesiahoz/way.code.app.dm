# RECIPE:Instalar Drupal (básico):
# ```console
# way @dm.test.drupal.local make.stack.drupal.basic -fvy
# ```
# :RECIPE

help: Crear nuevo sitio Drupal (básico)
example:
 - (({}.tmp.proc.sig))

task:
  require:
    config:
      - .*(\.local) origin
    args:
      command:
        required: false
        type: .*
        default: ""
    opt: {}
    settings:
      appsetting.stack: ^drupal
  do:
    - { event: 'origin startup' }

    # Levanta servicios
    -
      label: Apagando servicios
      call: exec
      args:
        cmd: (({}.exec)) (({origin}._config_name)) dm.down (({}.optSig))
        out: true 

    # Despliega stack
    - call: var
      args:
        key: deploy_all_stack
        value: true

    - label: Desplegando configuración
      call: dm.init
      args:
        remove_all: true
        name: "(({origin}.appsetting.stack))"
        include: []

    # Levanta servicios
    -
      label: Levantando servicios
      call: exec
      args:
        cmd: (({}.exec)) (({origin}._config_name)) dm.up (({}.optSig))
        out: true 

    # Instala Drupal
    -
      call: exec
      args:
        cmd: (({}.exec)) (({origin}._config_name)) make.drupal.install (({}.optSig))
        out: true

    # Establece proyecto Git
    - label: Estableciendo proyecto Git
      call: exec
      args:
        cd: (({origin}.appsetting.root))
        cmd: git init 2>/dev/null && git checkout -b develop && git add . && git config user.name 'dummy' && git config user.email 'dummy@dummy.org' && git commit -m "Initial commit" && git config --unset user.name && git config --unset user.email
        out: false

    - { event: 'origin windup' }